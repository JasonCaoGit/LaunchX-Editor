{"version":3,"sources":["file:///Users/kw/github/monaco-editor-core/out-editor-esm/vs/editor/contrib/inlineCompletions/browser/model/provideInlineCompletions.ts","vs/editor/contrib/inlineCompletions/browser/model/provideInlineCompletions.ts"],"names":[],"mappings":"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","file":"provideInlineCompletions.js","sourceRoot":"file:///Users/kw/github/monaco-editor-core/out-editor-esm","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { assertNever } from '../../../../../base/common/assert.js';\nimport { AsyncIterableObject, DeferredPromise } from '../../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { onUnexpectedExternalError } from '../../../../../base/common/errors.js';\nimport { Disposable, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { SetMap } from '../../../../../base/common/map.js';\nimport { generateUuid } from '../../../../../base/common/uuid.js';\nimport { ISingleEditOperation } from '../../../../common/core/editOperation.js';\nimport { SingleOffsetEdit } from '../../../../common/core/offsetEdit.js';\nimport { OffsetRange } from '../../../../common/core/offsetRange.js';\nimport { Position } from '../../../../common/core/position.js';\nimport { Range } from '../../../../common/core/range.js';\nimport { SingleTextEdit } from '../../../../common/core/textEdit.js';\nimport { LanguageFeatureRegistry } from '../../../../common/languageFeatureRegistry.js';\nimport { Command, InlineCompletion, InlineCompletionContext, InlineCompletionProviderGroupId, InlineCompletions, InlineCompletionsProvider, InlineCompletionTriggerKind } from '../../../../common/languages.js';\nimport { ILanguageConfigurationService } from '../../../../common/languages/languageConfigurationRegistry.js';\nimport { ITextModel } from '../../../../common/model.js';\nimport { fixBracketsInLine } from '../../../../common/model/bracketPairsTextModelPart/fixBrackets.js';\nimport { TextModelText } from '../../../../common/model/textModelText.js';\nimport { SnippetParser, Text } from '../../../snippet/browser/snippetParser.js';\nimport { getReadonlyEmptyArray } from '../utils.js';\n\nexport async function provideInlineCompletions(\n\tregistry: LanguageFeatureRegistry<InlineCompletionsProvider>,\n\tpositionOrRange: Position | Range,\n\tmodel: ITextModel,\n\tcontext: InlineCompletionContext,\n\tbaseToken: CancellationToken = CancellationToken.None,\n\tlanguageConfigurationService?: ILanguageConfigurationService,\n): Promise<InlineCompletionProviderResult> {\n\tconst requestUuid = generateUuid();\n\tconst tokenSource = new CancellationTokenSource(baseToken);\n\tconst token = tokenSource.token;\n\tconst contextWithUuid = { ...context, requestUuid: requestUuid };\n\n\tconst defaultReplaceRange = positionOrRange instanceof Position ? getDefaultRange(positionOrRange, model) : positionOrRange;\n\tconst providers = registry.all(model);\n\n\tconst multiMap = new SetMap<InlineCompletionProviderGroupId, InlineCompletionsProvider<any>>();\n\tfor (const provider of providers) {\n\t\tif (provider.groupId) {\n\t\t\tmultiMap.add(provider.groupId, provider);\n\t\t}\n\t}\n\n\tfunction getPreferredProviders(provider: InlineCompletionsProvider<any>): InlineCompletionsProvider<any>[] {\n\t\tif (!provider.yieldsToGroupIds) { return []; }\n\t\tconst result: InlineCompletionsProvider<any>[] = [];\n\t\tfor (const groupId of provider.yieldsToGroupIds || []) {\n\t\t\tconst providers = multiMap.get(groupId);\n\t\t\tfor (const p of providers) {\n\t\t\t\tresult.push(p);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\ttype Result = Promise<InlineCompletionList | undefined>;\n\tconst states = new Map<InlineCompletionsProvider, Result>();\n\n\tconst seen = new Set<InlineCompletionsProvider>();\n\tfunction findPreferredProviderCircle(\n\t\tprovider: InlineCompletionsProvider<any>,\n\t\tstack: InlineCompletionsProvider[]\n\t): InlineCompletionsProvider[] | undefined {\n\t\tstack = [...stack, provider];\n\t\tif (seen.has(provider)) { return stack; }\n\n\t\tseen.add(provider);\n\t\ttry {\n\t\t\tconst preferred = getPreferredProviders(provider);\n\t\t\tfor (const p of preferred) {\n\t\t\t\tconst c = findPreferredProviderCircle(p, stack);\n\t\t\t\tif (c) { return c; }\n\t\t\t}\n\t\t} finally {\n\t\t\tseen.delete(provider);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tfunction queryProviderOrPreferredProvider(provider: InlineCompletionsProvider<InlineCompletions>): Result {\n\t\tconst state = states.get(provider);\n\t\tif (state) { return state; }\n\n\t\tconst circle = findPreferredProviderCircle(provider, []);\n\t\tif (circle) {\n\t\t\tonUnexpectedExternalError(new Error(`Inline completions: cyclic yield-to dependency detected.`\n\t\t\t\t+ ` Path: ${circle.map(s => s.toString ? s.toString() : ('' + s)).join(' -> ')}`));\n\t\t}\n\n\t\tconst deferredPromise = new DeferredPromise<InlineCompletionList | undefined>();\n\t\tstates.set(provider, deferredPromise.p);\n\n\t\t(async () => {\n\t\t\tif (!circle) {\n\t\t\t\tconst preferred = getPreferredProviders(provider);\n\t\t\t\tfor (const p of preferred) {\n\t\t\t\t\tconst result = await queryProviderOrPreferredProvider(p);\n\t\t\t\t\tif (result && result.inlineCompletions.items.length > 0) {\n\t\t\t\t\t\t// Skip provider\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn query(provider);\n\t\t})().then(c => deferredPromise.complete(c), e => deferredPromise.error(e));\n\n\t\treturn deferredPromise.p;\n\t}\n\n\tasync function query(provider: InlineCompletionsProvider): Promise<InlineCompletionList | undefined> {\n\t\tlet result: InlineCompletions | null | undefined;\n\t\ttry {\n\t\t\tif (positionOrRange instanceof Position) {\n\t\t\t\tresult = await provider.provideInlineCompletions(model, positionOrRange, contextWithUuid, token);\n\t\t\t} else {\n\t\t\t\tresult = await provider.provideInlineEditsForRange?.(model, positionOrRange, contextWithUuid, token);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tonUnexpectedExternalError(e);\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!result) { return undefined; }\n\t\tconst list = new InlineCompletionList(result, provider);\n\n\t\trunWhenCancelled(token, () => list.removeRef());\n\t\treturn list;\n\t}\n\n\tconst inlineCompletionLists = AsyncIterableObject.fromPromisesResolveOrder(providers.map(queryProviderOrPreferredProvider));\n\n\tif (token.isCancellationRequested) {\n\t\ttokenSource.dispose(true);\n\t\t// result has been disposed before we could call addRef! So we have to discard everything.\n\t\treturn new InlineCompletionProviderResult([], new Set(), []);\n\t}\n\n\tconst result = await addRefAndCreateResult(contextWithUuid, inlineCompletionLists, defaultReplaceRange, model, languageConfigurationService);\n\ttokenSource.dispose(true); // This disposes results that are not referenced.\n\treturn result;\n}\n\n/** If the token does not leak, this will not leak either. */\nfunction runWhenCancelled(token: CancellationToken, callback: () => void): IDisposable {\n\tif (token.isCancellationRequested) {\n\t\tcallback();\n\t\treturn Disposable.None;\n\t} else {\n\t\tconst listener = token.onCancellationRequested(() => {\n\t\t\tlistener.dispose();\n\t\t\tcallback();\n\t\t});\n\t\treturn { dispose: () => listener.dispose() };\n\t}\n}\n\n// TODO: check cancellation token!\nasync function addRefAndCreateResult(\n\tcontext: InlineCompletionContext,\n\tinlineCompletionLists: AsyncIterable<(InlineCompletionList | undefined)>,\n\tdefaultReplaceRange: Range,\n\tmodel: ITextModel,\n\tlanguageConfigurationService: ILanguageConfigurationService | undefined\n): Promise<InlineCompletionProviderResult> {\n\t// for deduplication\n\tconst itemsByHash = new Map<string, InlineCompletionItem>();\n\n\tlet shouldStop = false;\n\tconst lists: InlineCompletionList[] = [];\n\tfor await (const completions of inlineCompletionLists) {\n\t\tif (!completions) { continue; }\n\t\tcompletions.addRef();\n\t\tlists.push(completions);\n\t\tfor (const item of completions.inlineCompletions.items) {\n\t\t\tif (!context.includeInlineEdits && item.isInlineEdit) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!context.includeInlineCompletions && !item.isInlineEdit) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst inlineCompletionItem = InlineCompletionItem.from(\n\t\t\t\titem,\n\t\t\t\tcompletions,\n\t\t\t\tdefaultReplaceRange,\n\t\t\t\tmodel,\n\t\t\t\tlanguageConfigurationService\n\t\t\t);\n\n\t\t\titemsByHash.set(inlineCompletionItem.hash(), inlineCompletionItem);\n\n\t\t\t// Stop after first visible inline completion\n\t\t\tif (!item.isInlineEdit && context.triggerKind === InlineCompletionTriggerKind.Automatic) {\n\t\t\t\tconst minifiedEdit = inlineCompletionItem.toSingleTextEdit().removeCommonPrefix(new TextModelText(model));\n\t\t\t\tif (!minifiedEdit.isEmpty) {\n\t\t\t\t\tshouldStop = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (shouldStop) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn new InlineCompletionProviderResult(Array.from(itemsByHash.values()), new Set(itemsByHash.keys()), lists);\n}\n\nexport class InlineCompletionProviderResult implements IDisposable {\n\n\tconstructor(\n\t\t/**\n\t\t * Free of duplicates.\n\t\t */\n\t\tpublic readonly completions: readonly InlineCompletionItem[],\n\t\tprivate readonly hashs: Set<string>,\n\t\tprivate readonly providerResults: readonly InlineCompletionList[],\n\t) { }\n\n\tpublic has(item: InlineCompletionItem): boolean {\n\t\treturn this.hashs.has(item.hash());\n\t}\n\n\tdispose(): void {\n\t\tfor (const result of this.providerResults) {\n\t\t\tresult.removeRef();\n\t\t}\n\t}\n}\n\n/**\n * A ref counted pointer to the computed `InlineCompletions` and the `InlineCompletionsProvider` that\n * computed them.\n */\nexport class InlineCompletionList {\n\tprivate refCount = 1;\n\tconstructor(\n\t\tpublic readonly inlineCompletions: InlineCompletions,\n\t\tpublic readonly provider: InlineCompletionsProvider,\n\t) { }\n\n\taddRef(): void {\n\t\tthis.refCount++;\n\t}\n\n\tremoveRef(): void {\n\t\tthis.refCount--;\n\t\tif (this.refCount === 0) {\n\t\t\tthis.provider.freeInlineCompletions(this.inlineCompletions);\n\t\t}\n\t}\n}\n\nexport class InlineCompletionItem {\n\tpublic static from(\n\t\tinlineCompletion: InlineCompletion,\n\t\tsource: InlineCompletionList,\n\t\tdefaultReplaceRange: Range,\n\t\ttextModel: ITextModel,\n\t\tlanguageConfigurationService: ILanguageConfigurationService | undefined,\n\t) {\n\t\tlet insertText: string;\n\t\tlet snippetInfo: SnippetInfo | undefined;\n\t\tlet range = inlineCompletion.range ? Range.lift(inlineCompletion.range) : defaultReplaceRange;\n\n\t\tif (typeof inlineCompletion.insertText === 'string') {\n\t\t\tinsertText = inlineCompletion.insertText;\n\n\t\t\tif (languageConfigurationService && inlineCompletion.completeBracketPairs) {\n\t\t\t\tinsertText = closeBrackets(\n\t\t\t\t\tinsertText,\n\t\t\t\t\trange.getStartPosition(),\n\t\t\t\t\ttextModel,\n\t\t\t\t\tlanguageConfigurationService\n\t\t\t\t);\n\n\t\t\t\t// Modify range depending on if brackets are added or removed\n\t\t\t\tconst diff = insertText.length - inlineCompletion.insertText.length;\n\t\t\t\tif (diff !== 0) {\n\t\t\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + diff);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsnippetInfo = undefined;\n\t\t} else if ('snippet' in inlineCompletion.insertText) {\n\t\t\tconst preBracketCompletionLength = inlineCompletion.insertText.snippet.length;\n\n\t\t\tif (languageConfigurationService && inlineCompletion.completeBracketPairs) {\n\t\t\t\tinlineCompletion.insertText.snippet = closeBrackets(\n\t\t\t\t\tinlineCompletion.insertText.snippet,\n\t\t\t\t\trange.getStartPosition(),\n\t\t\t\t\ttextModel,\n\t\t\t\t\tlanguageConfigurationService\n\t\t\t\t);\n\n\t\t\t\t// Modify range depending on if brackets are added or removed\n\t\t\t\tconst diff = inlineCompletion.insertText.snippet.length - preBracketCompletionLength;\n\t\t\t\tif (diff !== 0) {\n\t\t\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + diff);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst snippet = new SnippetParser().parse(inlineCompletion.insertText.snippet);\n\n\t\t\tif (snippet.children.length === 1 && snippet.children[0] instanceof Text) {\n\t\t\t\tinsertText = snippet.children[0].value;\n\t\t\t\tsnippetInfo = undefined;\n\t\t\t} else {\n\t\t\t\tinsertText = snippet.toString();\n\t\t\t\tsnippetInfo = {\n\t\t\t\t\tsnippet: inlineCompletion.insertText.snippet,\n\t\t\t\t\trange: range\n\t\t\t\t};\n\t\t\t}\n\t\t} else {\n\t\t\tassertNever(inlineCompletion.insertText);\n\t\t}\n\n\t\treturn new InlineCompletionItem(\n\t\t\tinsertText,\n\t\t\tinlineCompletion.command,\n\t\t\tinlineCompletion.shownCommand,\n\t\t\trange,\n\t\t\tinsertText,\n\t\t\tsnippetInfo,\n\t\t\tRange.lift(inlineCompletion.showRange) ?? undefined,\n\t\t\tinlineCompletion.additionalTextEdits || getReadonlyEmptyArray(),\n\t\t\tinlineCompletion,\n\t\t\tsource,\n\t\t);\n\t}\n\n\tstatic ID = 1;\n\n\tprivate _didCallShow = false;\n\n\tconstructor(\n\t\treadonly filterText: string,\n\t\treadonly command: Command | undefined,\n\t\treadonly shownCommand: Command | undefined,\n\t\treadonly range: Range,\n\t\treadonly insertText: string,\n\t\treadonly snippetInfo: SnippetInfo | undefined,\n\t\treadonly cursorShowRange: Range | undefined,\n\n\t\treadonly additionalTextEdits: readonly ISingleEditOperation[],\n\n\n\t\t/**\n\t\t * A reference to the original inline completion this inline completion has been constructed from.\n\t\t * Used for event data to ensure referential equality.\n\t\t*/\n\t\treadonly sourceInlineCompletion: InlineCompletion,\n\n\t\t/**\n\t\t * A reference to the original inline completion list this inline completion has been constructed from.\n\t\t * Used for event data to ensure referential equality.\n\t\t*/\n\t\treadonly source: InlineCompletionList,\n\n\t\treadonly id = `InlineCompletion:${InlineCompletionItem.ID++}`,\n\t) {\n\t\t// TODO: these statements are no-ops\n\t\tfilterText = filterText.replace(/\\r\\n|\\r/g, '\\n');\n\t\tinsertText = filterText.replace(/\\r\\n|\\r/g, '\\n');\n\t}\n\n\tpublic get didShow(): boolean {\n\t\treturn this._didCallShow;\n\t}\n\tpublic markAsShown(): void {\n\t\tthis._didCallShow = true;\n\t}\n\n\tpublic withRange(updatedRange: Range): InlineCompletionItem {\n\t\treturn new InlineCompletionItem(\n\t\t\tthis.filterText,\n\t\t\tthis.command,\n\t\t\tthis.shownCommand,\n\t\t\tupdatedRange,\n\t\t\tthis.insertText,\n\t\t\tthis.snippetInfo,\n\t\t\tthis.cursorShowRange,\n\t\t\tthis.additionalTextEdits,\n\t\t\tthis.sourceInlineCompletion,\n\t\t\tthis.source,\n\t\t\tthis.id,\n\t\t);\n\t}\n\n\tpublic withRangeInsertTextAndFilterText(updatedRange: Range, updatedInsertText: string, updatedFilterText: string): InlineCompletionItem {\n\t\treturn new InlineCompletionItem(\n\t\t\tupdatedFilterText,\n\t\t\tthis.command,\n\t\t\tthis.shownCommand,\n\t\t\tupdatedRange,\n\t\t\tupdatedInsertText,\n\t\t\tthis.snippetInfo,\n\t\t\tthis.cursorShowRange,\n\t\t\tthis.additionalTextEdits,\n\t\t\tthis.sourceInlineCompletion,\n\t\t\tthis.source,\n\t\t\tthis.id,\n\t\t);\n\t}\n\n\tpublic hash(): string {\n\t\treturn JSON.stringify({ insertText: this.insertText, range: this.range.toString() });\n\t}\n\n\tpublic toSingleTextEdit(): SingleTextEdit {\n\t\treturn new SingleTextEdit(this.range, this.insertText);\n\t}\n}\n\nexport interface SnippetInfo {\n\tsnippet: string;\n\t/* Could be different than the main range */\n\trange: Range;\n}\n\nfunction getDefaultRange(position: Position, model: ITextModel): Range {\n\tconst word = model.getWordAtPosition(position);\n\tconst maxColumn = model.getLineMaxColumn(position.lineNumber);\n\t// By default, always replace up until the end of the current line.\n\t// This default might be subject to change!\n\treturn word\n\t\t? new Range(position.lineNumber, word.startColumn, position.lineNumber, maxColumn)\n\t\t: Range.fromPositions(position, position.with(undefined, maxColumn));\n}\n\nfunction closeBrackets(text: string, position: Position, model: ITextModel, languageConfigurationService: ILanguageConfigurationService): string {\n\tconst currentLine = model.getLineContent(position.lineNumber);\n\tconst edit = SingleOffsetEdit.replace(new OffsetRange(position.column - 1, currentLine.length), text);\n\n\tconst proposedLineTokens = model.tokenization.tokenizeLinesAt(position.lineNumber, [edit.apply(currentLine)]);\n\tconst textTokens = proposedLineTokens?.[0].sliceZeroCopy(edit.getRangeAfterApply());\n\tif (!textTokens) {\n\t\treturn text;\n\t}\n\n\tconst fixedText = fixBracketsInLine(textTokens, languageConfigurationService);\n\treturn fixedText;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { assertNever } from '../../../../../base/common/assert.js';\nimport { AsyncIterableObject, DeferredPromise } from '../../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { onUnexpectedExternalError } from '../../../../../base/common/errors.js';\nimport { Disposable, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { SetMap } from '../../../../../base/common/map.js';\nimport { generateUuid } from '../../../../../base/common/uuid.js';\nimport { ISingleEditOperation } from '../../../../common/core/editOperation.js';\nimport { SingleOffsetEdit } from '../../../../common/core/offsetEdit.js';\nimport { OffsetRange } from '../../../../common/core/offsetRange.js';\nimport { Position } from '../../../../common/core/position.js';\nimport { Range } from '../../../../common/core/range.js';\nimport { SingleTextEdit } from '../../../../common/core/textEdit.js';\nimport { LanguageFeatureRegistry } from '../../../../common/languageFeatureRegistry.js';\nimport { Command, InlineCompletion, InlineCompletionContext, InlineCompletionProviderGroupId, InlineCompletions, InlineCompletionsProvider, InlineCompletionTriggerKind } from '../../../../common/languages.js';\nimport { ILanguageConfigurationService } from '../../../../common/languages/languageConfigurationRegistry.js';\nimport { ITextModel } from '../../../../common/model.js';\nimport { fixBracketsInLine } from '../../../../common/model/bracketPairsTextModelPart/fixBrackets.js';\nimport { TextModelText } from '../../../../common/model/textModelText.js';\nimport { SnippetParser, Text } from '../../../snippet/browser/snippetParser.js';\nimport { getReadonlyEmptyArray } from '../utils.js';\n\nexport async function provideInlineCompletions(\n\tregistry: LanguageFeatureRegistry<InlineCompletionsProvider>,\n\tpositionOrRange: Position | Range,\n\tmodel: ITextModel,\n\tcontext: InlineCompletionContext,\n\tbaseToken: CancellationToken = CancellationToken.None,\n\tlanguageConfigurationService?: ILanguageConfigurationService,\n): Promise<InlineCompletionProviderResult> {\n\tconst requestUuid = generateUuid();\n\tconst tokenSource = new CancellationTokenSource(baseToken);\n\tconst token = tokenSource.token;\n\tconst contextWithUuid = { ...context, requestUuid: requestUuid };\n\n\tconst defaultReplaceRange = positionOrRange instanceof Position ? getDefaultRange(positionOrRange, model) : positionOrRange;\n\tconst providers = registry.all(model);\n\n\tconst multiMap = new SetMap<InlineCompletionProviderGroupId, InlineCompletionsProvider<any>>();\n\tfor (const provider of providers) {\n\t\tif (provider.groupId) {\n\t\t\tmultiMap.add(provider.groupId, provider);\n\t\t}\n\t}\n\n\tfunction getPreferredProviders(provider: InlineCompletionsProvider<any>): InlineCompletionsProvider<any>[] {\n\t\tif (!provider.yieldsToGroupIds) { return []; }\n\t\tconst result: InlineCompletionsProvider<any>[] = [];\n\t\tfor (const groupId of provider.yieldsToGroupIds || []) {\n\t\t\tconst providers = multiMap.get(groupId);\n\t\t\tfor (const p of providers) {\n\t\t\t\tresult.push(p);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\ttype Result = Promise<InlineCompletionList | undefined>;\n\tconst states = new Map<InlineCompletionsProvider, Result>();\n\n\tconst seen = new Set<InlineCompletionsProvider>();\n\tfunction findPreferredProviderCircle(\n\t\tprovider: InlineCompletionsProvider<any>,\n\t\tstack: InlineCompletionsProvider[]\n\t): InlineCompletionsProvider[] | undefined {\n\t\tstack = [...stack, provider];\n\t\tif (seen.has(provider)) { return stack; }\n\n\t\tseen.add(provider);\n\t\ttry {\n\t\t\tconst preferred = getPreferredProviders(provider);\n\t\t\tfor (const p of preferred) {\n\t\t\t\tconst c = findPreferredProviderCircle(p, stack);\n\t\t\t\tif (c) { return c; }\n\t\t\t}\n\t\t} finally {\n\t\t\tseen.delete(provider);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tfunction queryProviderOrPreferredProvider(provider: InlineCompletionsProvider<InlineCompletions>): Result {\n\t\tconst state = states.get(provider);\n\t\tif (state) { return state; }\n\n\t\tconst circle = findPreferredProviderCircle(provider, []);\n\t\tif (circle) {\n\t\t\tonUnexpectedExternalError(new Error(`Inline completions: cyclic yield-to dependency detected.`\n\t\t\t\t+ ` Path: ${circle.map(s => s.toString ? s.toString() : ('' + s)).join(' -> ')}`));\n\t\t}\n\n\t\tconst deferredPromise = new DeferredPromise<InlineCompletionList | undefined>();\n\t\tstates.set(provider, deferredPromise.p);\n\n\t\t(async () => {\n\t\t\tif (!circle) {\n\t\t\t\tconst preferred = getPreferredProviders(provider);\n\t\t\t\tfor (const p of preferred) {\n\t\t\t\t\tconst result = await queryProviderOrPreferredProvider(p);\n\t\t\t\t\tif (result && result.inlineCompletions.items.length > 0) {\n\t\t\t\t\t\t// Skip provider\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn query(provider);\n\t\t})().then(c => deferredPromise.complete(c), e => deferredPromise.error(e));\n\n\t\treturn deferredPromise.p;\n\t}\n\n\tasync function query(provider: InlineCompletionsProvider): Promise<InlineCompletionList | undefined> {\n\t\tlet result: InlineCompletions | null | undefined;\n\t\ttry {\n\t\t\tif (positionOrRange instanceof Position) {\n\t\t\t\tresult = await provider.provideInlineCompletions(model, positionOrRange, contextWithUuid, token);\n\t\t\t} else {\n\t\t\t\tresult = await provider.provideInlineEditsForRange?.(model, positionOrRange, contextWithUuid, token);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tonUnexpectedExternalError(e);\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!result) { return undefined; }\n\t\tconst list = new InlineCompletionList(result, provider);\n\n\t\trunWhenCancelled(token, () => list.removeRef());\n\t\treturn list;\n\t}\n\n\tconst inlineCompletionLists = AsyncIterableObject.fromPromisesResolveOrder(providers.map(queryProviderOrPreferredProvider));\n\n\tif (token.isCancellationRequested) {\n\t\ttokenSource.dispose(true);\n\t\t// result has been disposed before we could call addRef! So we have to discard everything.\n\t\treturn new InlineCompletionProviderResult([], new Set(), []);\n\t}\n\n\tconst result = await addRefAndCreateResult(contextWithUuid, inlineCompletionLists, defaultReplaceRange, model, languageConfigurationService);\n\ttokenSource.dispose(true); // This disposes results that are not referenced.\n\treturn result;\n}\n\n/** If the token does not leak, this will not leak either. */\nfunction runWhenCancelled(token: CancellationToken, callback: () => void): IDisposable {\n\tif (token.isCancellationRequested) {\n\t\tcallback();\n\t\treturn Disposable.None;\n\t} else {\n\t\tconst listener = token.onCancellationRequested(() => {\n\t\t\tlistener.dispose();\n\t\t\tcallback();\n\t\t});\n\t\treturn { dispose: () => listener.dispose() };\n\t}\n}\n\n// TODO: check cancellation token!\nasync function addRefAndCreateResult(\n\tcontext: InlineCompletionContext,\n\tinlineCompletionLists: AsyncIterable<(InlineCompletionList | undefined)>,\n\tdefaultReplaceRange: Range,\n\tmodel: ITextModel,\n\tlanguageConfigurationService: ILanguageConfigurationService | undefined\n): Promise<InlineCompletionProviderResult> {\n\t// for deduplication\n\tconst itemsByHash = new Map<string, InlineCompletionItem>();\n\n\tlet shouldStop = false;\n\tconst lists: InlineCompletionList[] = [];\n\tfor await (const completions of inlineCompletionLists) {\n\t\tif (!completions) { continue; }\n\t\tcompletions.addRef();\n\t\tlists.push(completions);\n\t\tfor (const item of completions.inlineCompletions.items) {\n\t\t\tif (!context.includeInlineEdits && item.isInlineEdit) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!context.includeInlineCompletions && !item.isInlineEdit) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst inlineCompletionItem = InlineCompletionItem.from(\n\t\t\t\titem,\n\t\t\t\tcompletions,\n\t\t\t\tdefaultReplaceRange,\n\t\t\t\tmodel,\n\t\t\t\tlanguageConfigurationService\n\t\t\t);\n\n\t\t\titemsByHash.set(inlineCompletionItem.hash(), inlineCompletionItem);\n\n\t\t\t// Stop after first visible inline completion\n\t\t\tif (!item.isInlineEdit && context.triggerKind === InlineCompletionTriggerKind.Automatic) {\n\t\t\t\tconst minifiedEdit = inlineCompletionItem.toSingleTextEdit().removeCommonPrefix(new TextModelText(model));\n\t\t\t\tif (!minifiedEdit.isEmpty) {\n\t\t\t\t\tshouldStop = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (shouldStop) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn new InlineCompletionProviderResult(Array.from(itemsByHash.values()), new Set(itemsByHash.keys()), lists);\n}\n\nexport class InlineCompletionProviderResult implements IDisposable {\n\n\tconstructor(\n\t\t/**\n\t\t * Free of duplicates.\n\t\t */\n\t\tpublic readonly completions: readonly InlineCompletionItem[],\n\t\tprivate readonly hashs: Set<string>,\n\t\tprivate readonly providerResults: readonly InlineCompletionList[],\n\t) { }\n\n\tpublic has(item: InlineCompletionItem): boolean {\n\t\treturn this.hashs.has(item.hash());\n\t}\n\n\tdispose(): void {\n\t\tfor (const result of this.providerResults) {\n\t\t\tresult.removeRef();\n\t\t}\n\t}\n}\n\n/**\n * A ref counted pointer to the computed `InlineCompletions` and the `InlineCompletionsProvider` that\n * computed them.\n */\nexport class InlineCompletionList {\n\tprivate refCount = 1;\n\tconstructor(\n\t\tpublic readonly inlineCompletions: InlineCompletions,\n\t\tpublic readonly provider: InlineCompletionsProvider,\n\t) { }\n\n\taddRef(): void {\n\t\tthis.refCount++;\n\t}\n\n\tremoveRef(): void {\n\t\tthis.refCount--;\n\t\tif (this.refCount === 0) {\n\t\t\tthis.provider.freeInlineCompletions(this.inlineCompletions);\n\t\t}\n\t}\n}\n\nexport class InlineCompletionItem {\n\tpublic static from(\n\t\tinlineCompletion: InlineCompletion,\n\t\tsource: InlineCompletionList,\n\t\tdefaultReplaceRange: Range,\n\t\ttextModel: ITextModel,\n\t\tlanguageConfigurationService: ILanguageConfigurationService | undefined,\n\t) {\n\t\tlet insertText: string;\n\t\tlet snippetInfo: SnippetInfo | undefined;\n\t\tlet range = inlineCompletion.range ? Range.lift(inlineCompletion.range) : defaultReplaceRange;\n\n\t\tif (typeof inlineCompletion.insertText === 'string') {\n\t\t\tinsertText = inlineCompletion.insertText;\n\n\t\t\tif (languageConfigurationService && inlineCompletion.completeBracketPairs) {\n\t\t\t\tinsertText = closeBrackets(\n\t\t\t\t\tinsertText,\n\t\t\t\t\trange.getStartPosition(),\n\t\t\t\t\ttextModel,\n\t\t\t\t\tlanguageConfigurationService\n\t\t\t\t);\n\n\t\t\t\t// Modify range depending on if brackets are added or removed\n\t\t\t\tconst diff = insertText.length - inlineCompletion.insertText.length;\n\t\t\t\tif (diff !== 0) {\n\t\t\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + diff);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsnippetInfo = undefined;\n\t\t} else if ('snippet' in inlineCompletion.insertText) {\n\t\t\tconst preBracketCompletionLength = inlineCompletion.insertText.snippet.length;\n\n\t\t\tif (languageConfigurationService && inlineCompletion.completeBracketPairs) {\n\t\t\t\tinlineCompletion.insertText.snippet = closeBrackets(\n\t\t\t\t\tinlineCompletion.insertText.snippet,\n\t\t\t\t\trange.getStartPosition(),\n\t\t\t\t\ttextModel,\n\t\t\t\t\tlanguageConfigurationService\n\t\t\t\t);\n\n\t\t\t\t// Modify range depending on if brackets are added or removed\n\t\t\t\tconst diff = inlineCompletion.insertText.snippet.length - preBracketCompletionLength;\n\t\t\t\tif (diff !== 0) {\n\t\t\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + diff);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst snippet = new SnippetParser().parse(inlineCompletion.insertText.snippet);\n\n\t\t\tif (snippet.children.length === 1 && snippet.children[0] instanceof Text) {\n\t\t\t\tinsertText = snippet.children[0].value;\n\t\t\t\tsnippetInfo = undefined;\n\t\t\t} else {\n\t\t\t\tinsertText = snippet.toString();\n\t\t\t\tsnippetInfo = {\n\t\t\t\t\tsnippet: inlineCompletion.insertText.snippet,\n\t\t\t\t\trange: range\n\t\t\t\t};\n\t\t\t}\n\t\t} else {\n\t\t\tassertNever(inlineCompletion.insertText);\n\t\t}\n\n\t\treturn new InlineCompletionItem(\n\t\t\tinsertText,\n\t\t\tinlineCompletion.command,\n\t\t\tinlineCompletion.shownCommand,\n\t\t\trange,\n\t\t\tinsertText,\n\t\t\tsnippetInfo,\n\t\t\tRange.lift(inlineCompletion.showRange) ?? undefined,\n\t\t\tinlineCompletion.additionalTextEdits || getReadonlyEmptyArray(),\n\t\t\tinlineCompletion,\n\t\t\tsource,\n\t\t);\n\t}\n\n\tstatic ID = 1;\n\n\tprivate _didCallShow = false;\n\n\tconstructor(\n\t\treadonly filterText: string,\n\t\treadonly command: Command | undefined,\n\t\treadonly shownCommand: Command | undefined,\n\t\treadonly range: Range,\n\t\treadonly insertText: string,\n\t\treadonly snippetInfo: SnippetInfo | undefined,\n\t\treadonly cursorShowRange: Range | undefined,\n\n\t\treadonly additionalTextEdits: readonly ISingleEditOperation[],\n\n\n\t\t/**\n\t\t * A reference to the original inline completion this inline completion has been constructed from.\n\t\t * Used for event data to ensure referential equality.\n\t\t*/\n\t\treadonly sourceInlineCompletion: InlineCompletion,\n\n\t\t/**\n\t\t * A reference to the original inline completion list this inline completion has been constructed from.\n\t\t * Used for event data to ensure referential equality.\n\t\t*/\n\t\treadonly source: InlineCompletionList,\n\n\t\treadonly id = `InlineCompletion:${InlineCompletionItem.ID++}`,\n\t) {\n\t\t// TODO: these statements are no-ops\n\t\tfilterText = filterText.replace(/\\r\\n|\\r/g, '\\n');\n\t\tinsertText = filterText.replace(/\\r\\n|\\r/g, '\\n');\n\t}\n\n\tpublic get didShow(): boolean {\n\t\treturn this._didCallShow;\n\t}\n\tpublic markAsShown(): void {\n\t\tthis._didCallShow = true;\n\t}\n\n\tpublic withRange(updatedRange: Range): InlineCompletionItem {\n\t\treturn new InlineCompletionItem(\n\t\t\tthis.filterText,\n\t\t\tthis.command,\n\t\t\tthis.shownCommand,\n\t\t\tupdatedRange,\n\t\t\tthis.insertText,\n\t\t\tthis.snippetInfo,\n\t\t\tthis.cursorShowRange,\n\t\t\tthis.additionalTextEdits,\n\t\t\tthis.sourceInlineCompletion,\n\t\t\tthis.source,\n\t\t\tthis.id,\n\t\t);\n\t}\n\n\tpublic withRangeInsertTextAndFilterText(updatedRange: Range, updatedInsertText: string, updatedFilterText: string): InlineCompletionItem {\n\t\treturn new InlineCompletionItem(\n\t\t\tupdatedFilterText,\n\t\t\tthis.command,\n\t\t\tthis.shownCommand,\n\t\t\tupdatedRange,\n\t\t\tupdatedInsertText,\n\t\t\tthis.snippetInfo,\n\t\t\tthis.cursorShowRange,\n\t\t\tthis.additionalTextEdits,\n\t\t\tthis.sourceInlineCompletion,\n\t\t\tthis.source,\n\t\t\tthis.id,\n\t\t);\n\t}\n\n\tpublic hash(): string {\n\t\treturn JSON.stringify({ insertText: this.insertText, range: this.range.toString() });\n\t}\n\n\tpublic toSingleTextEdit(): SingleTextEdit {\n\t\treturn new SingleTextEdit(this.range, this.insertText);\n\t}\n}\n\nexport interface SnippetInfo {\n\tsnippet: string;\n\t/* Could be different than the main range */\n\trange: Range;\n}\n\nfunction getDefaultRange(position: Position, model: ITextModel): Range {\n\tconst word = model.getWordAtPosition(position);\n\tconst maxColumn = model.getLineMaxColumn(position.lineNumber);\n\t// By default, always replace up until the end of the current line.\n\t// This default might be subject to change!\n\treturn word\n\t\t? new Range(position.lineNumber, word.startColumn, position.lineNumber, maxColumn)\n\t\t: Range.fromPositions(position, position.with(undefined, maxColumn));\n}\n\nfunction closeBrackets(text: string, position: Position, model: ITextModel, languageConfigurationService: ILanguageConfigurationService): string {\n\tconst currentLine = model.getLineContent(position.lineNumber);\n\tconst edit = SingleOffsetEdit.replace(new OffsetRange(position.column - 1, currentLine.length), text);\n\n\tconst proposedLineTokens = model.tokenization.tokenizeLinesAt(position.lineNumber, [edit.apply(currentLine)]);\n\tconst textTokens = proposedLineTokens?.[0].sliceZeroCopy(edit.getRangeAfterApply());\n\tif (!textTokens) {\n\t\treturn text;\n\t}\n\n\tconst fixedText = fixBracketsInLine(textTokens, languageConfigurationService);\n\treturn fixedText;\n}\n"]}